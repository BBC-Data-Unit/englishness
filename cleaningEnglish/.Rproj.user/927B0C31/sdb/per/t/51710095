{
    "collab_server" : "",
    "contents" : "---\ntitle: \"YouGov Englishness survey: rivalries\"\noutput: html_document\n---\n\n# YouGov Englishness survey: rivalries\n\nThe Englishness survey includes responses about rivalries, but these answers contain a number of problems, particularly:\n\n* Misspellings of the same place name\n* Multiple names in one response\n\nWe've created a lookup table using Open Refine and identified the top 50 places named.\n\nNow to grab the data from the YouGov XLS:\n\n```{r, eval=FALSE, include=FALSE}\n#This code chunk is set not to run because it's already been installed. However, if you get an error regarding rio below, you may want to install it by running the code here.\n#Install rio to make importing easier\ninstall.packages(\"rio\")\n```\n\nGrab sheet 4 with the rivalries data:\n\n```{r}\n#change this to new file name before running\nfilename <- \"englishnessmarch18v2.xls\"\n#activate rio library\nlibrary(rio)\n#import the third sheet of that filename\nrivalriesresults <- import(filename,sheet=4)\n```\n\nGrab the lookup table:\n\n```{r}\ntop50lookup <- import(\"top50lookup.csv\")\n```\n\n\n## Stripping back our rivalry data\n\nIt will help if we get rid of all commas, trailing and leading whitespace etc. - but the originals also have those. Just in case...\n\n```{r, eval=FALSE, include=FALSE}\n#Substitute commas for a space\n#rivalriesresults$rival <- gsub(\",\",\" \",rivalriesresults$`Please type in the place or places you’d consider to be a “rival”`)\n#Substitute double spaces\nrivalriesresults$rival <- gsub(\"  \",\" \",rivalriesresults$`Please type in the place or places you’d consider to be a “rival”`)\n#Substitute semi colons\n#rivalriesresults$rival <- gsub(\";\",\" \",rivalriesresults$`Please type in the place or places you’d consider to be a “rival”`)\n#Trim leading and trailing white space\nrivalriesresults$rival <- trimws(rivalriesresults$rival)\n```\n\n## Merging (VLOOKUP)\n\n```{r}\n#Make sure both data frames have a column with the same name\ncolnames(top50lookup)[1] <- \"rival\"\nrivalriesresults$rival <- rivalriesresults$`Please type in the place or places you’d consider to be a “rival”`\n#Create merged version. all.x = TRUE makes it a LEFT JOIN, i.e. no data from x is lost when there's no match\nrivalries.withlookup <- merge(x = rivalriesresults, y = top50lookup, all.x = TRUE)\n```\n\n## Pivot table\n\nWe can create a basic pivot like so:\n\n```{r}\nrivalriespivot <- data.frame(table(rivalries.withlookup$`Clean version`))\n```\n\nBut many entries will include names and not be limited to those. We need to find a way to check whether each entry *contains* a name.\n\n## Create columns for most popular locations\n\nOne approach to doing this would be with two functions: `grepl` and [`xor`](http://stat.ethz.ch/R-manual/R-devel/library/base/html/assign.html). \n\n* `grepl` will check whether each cell contains a value and return TRUE or FALSE. \n* `xor` is R's version of Excel's `OR` function: it will check whether one *or* the other of two values is TRUE. We need this because we're going to have more than one set of T/F results for each check against a name (there's more than one spelling of 'Manchester' being used)\n\nBelow we test some approaches:\n\n```{r}\n#First we create a test vector of possible names to match on\nmanc <- c(\"Manchester\",\"Manchestet\")\n#pmatch - partial match - can work but it only matches at the start of the string\nrivalries.withlookup$lancs <- pmatch(rivalries.withlookup$`Please type in the place or places you’d consider to be a “rival”`, lancs, 0, duplicates.ok = T)\n#A loop with grepl could check for each - but the second loop overwrites the results of the first loop - so we need some way to avoid this\nfor (i in manc){\n  rivalries.withlookup$manchester <- grepl(i, rivalries.withlookup$`Please type in the place or places you’d consider to be a “rival”`, ignore.case = T)\n}\n\n#The solution is to use xor to compare each new vector of results with an ongoing one\n#First we create a vector containing entirely false results\ntruefalse <- grepl(\"FALSE\", rivalries.withlookup$`Please type in the place or places you’d consider to be a “rival”`, ignore.case = T)\n#Then loop through the vector of misspellings\nfor (i in 1:length(manc)){\n  print(i)\n  #Now we change truefalse to contain the results of comparing truefalse with the new vector of T/F matches against the misspelling. Some FALSE values will change to TRUE if they are TRUE in the comparison vector\n  #This repeats for each, but truefalse keeps a record\n  truefalse <- xor(truefalse,grepl(manc[i], rivalries.withlookup$`Please type in the place or places you’d consider to be a “rival”`, ignore.case = T))\n  \n}\n#Finally store the results in a column\nrivalries.withlookup$manchester <- truefalse\n#write.csv(rivalries.withlookup,\"rivalriesCHECK.csv\")\n```\n## Extract vectors for popular locations\n\nTo check if this works with multiple variations we need to create vectors for each of the most popular locations.\n\n```{r}\ncleancities <- tapply(top50lookup$`Grand Total`, top50lookup$`Clean version`, sum)\ncleancities <- cleancities[order(-cleancities)]\nhead(cleancities, 30)\ncleancities[1]\nlancs <- subset(top50lookup, top50lookup$`Clean version` == \"Lancashire\")\nlancs <- lancs$`Unclean or clean to lookup`\n```\n\nAnd to test:\n\n```{r}\nrivalries.withlookup$manc <- grepl(\"manc\", rivalries.withlookup$`Please type in the place or places you’d consider to be a “rival”`, ignore.case = T)\n```\n\nThat's one term but how about multiple ones?\n\nFirst, I tried looping through a vector of different variations of a name, using them with `grepl` to test if they exist, and then using `xor` to compare the results against an ongoing record (which starts with all FALSE). However, this didn't work properly.\n\n```{r}\ntruefalse <- grepl(\"FALSE\", rivalries.withlookup$`Please type in the place or places you’d consider to be a “rival”`, ignore.case = T)\nfor (i in 1:length(lancs)){\n  print(i)\n  #Now we change truefalse to contain the results of comparing truefalse with the new vector of T/F matches against the misspelling. Some FALSE values will change to TRUE if they are TRUE in the comparison vector\n  #This repeats for each, but truefalse keeps a record\n  truefalse <- xor(truefalse,grepl(lancs[i], rivalries.withlookup$`Please type in the place or places you’d consider to be a “rival”`, ignore.case = T))\n  \n}\n#Finally store the results in a column\nrivalries.withlookup$lancs <- truefalse\n```\n\nA much simpler approach was to just create one `grepl` test which used an 'or' operator `|` with all the variations separated by it. This is achieved by using the `paste` function to combine the vector of variations, and [the `collapse` operator](https://www.r-bloggers.com/collapse-pasting-in-r/) set to insert the `|` character between each one:\n\n```{r}\nrivalries.withlookup$lanc <- grepl(paste(lancs,collapse=\"|\"), rivalries.withlookup$`Please type in the place or places you’d consider to be a “rival”`, ignore.case = T)\n```\n\n\n## Birmingham\n\nNow to create a vector for Birmingham and repeat:\n\n```{r}\nbrum <- subset(top50lookup, top50lookup$`Clean version` == \"Birmingham\")\nbrum <- brum$`Unclean or clean to lookup`\n\nrivalries.withlookup$brum <- grepl(paste(brum,collapse=\"|\"), rivalries.withlookup$`Please type in the place or places you’d consider to be a “rival”`, ignore.case = T)\n```\n\nNow export:\n\n```{r}\nwrite.csv(rivalries.withlookup,\"rivalrieswithlookup.csv\")\n```\n\n\n",
    "created" : 1525790146740.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "366182996",
    "id" : "51710095",
    "lastKnownWriteTime" : 1526535560,
    "last_content_update" : 1526535560370,
    "path" : "~/Documents/GitHub/Rintro/cleaning/cleaningEnglish/rivalries.Rmd",
    "project_path" : "rivalries.Rmd",
    "properties" : {
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}